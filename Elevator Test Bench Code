LIBRARY IEEE;
USE IEEE.STD_LOGIC_1164.ALL;
USE IEEE.NUMERIC_STD.ALL;

ENTITY tbElevator IS
END tbElevator;

ARCHITECTURE Behavioral of tbElevator IS

    signal clk : std_logic := '0';
    signal HardReset : std_logic := '0';
    signal SoftReset : std_logic := '0';
    signal estop : std_logic := '0';
    signal tick : std_logic := '0';
    signal ReqButtons : std_logic_vector(3 downto 0) := (others => '0');
    
    signal CurrentFloor : integer;
    signal DoorOpen, MovingUp, MovingDown : std_logic;
    signal debugger : std_logic_vector(2 downto 0);

    constant CLKPERIOD : time := 20 ns;

BEGIN

    UUT: ENTITY work.ElevatorController
        generic map(
            NumFloors => 4,
            TravelTime => 2,
            DoorTime => 2 
        )
        port map (
            clk => clk,
            HardReset => HardReset,
            SoftReset => SoftReset,
            estop => estop,
            tick => tick,
            ReqButtons => ReqButtons,
            CurrentFloor => CurrentFloor,
            DoorOpen => DoorOpen,
            MovingUp => MovingUp,
            MovingDown => MovingDown,
            debugger => debugger
        );

    -- Clock Generation
    clk_process: process
    BEGIN
        clk <= '0'; wait for CLK_PERIOD/2;
        clk <= '1'; wait for CLK_PERIOD/2;
    END process;

    -- 1Hz Tick Simulation (Fast mode for TB)
    tick_process: process
    BEGIN
        wait for CLK_PERIOD * 10; -- Wait 10 cycles
        tick <= '1';
        wait for CLK_PERIOD;
        tick <= '0';
    END process;

    -- Stimulus Process
    stim_proc: process
    BEGIN
        -- 1. Reset System (GR-5b)
        HardReset <= '1';
        wait for 100 ns;
        HardReset <= '0';
        wait for 100 ns;
        
        report "Test 1: Basic Request Floor 2";
        ReqButtons(2) <= '1';
        wait for CLK_PERIOD * 2;
        ReqButtons(2) <= '0'; -- Release button
        
        -- Wait for arrival (Move UP -> Arrive -> Door Open)
        wait until door_open = '1';
        assert current_floor = 2 report "Failed: Did not arrive at floor 2" severity failure;
        report "Success: Arrived at Floor 2";

        -- Wait for door to close
        wait until DoorOpen = '0'; 
        wait for 200 ns;

        report "Test 2: Directional Priority (VR-3a)";
        -- While at floor 2, request 0 (Down) and 3 (Up). 
        -- Wait... Logic dictates IDLE picks nearest? 
        -- Actually, let's test moving logic.
        -- Request 0. Start moving down. Then Request 1.
        ReqButtons(0) <= '1';
        wait for CLK_PERIOD * 20; -- Wait until start moving down
        ReqButtons(0) <= '0';
        
        -- Inject Request for Floor 1 mid-motion
        ReqButtons(1) <= '1'; 
        wait for CLK_PERIOD * 2;
        ReqButtons(1) <= '0';
        
        -- Should stop at 1 first (VR-3a request below current while moving down)
        wait until door_open = '1';
        assert CurrentFloor = 1 report "Failed: Skipped Floor 1" severity error;
        report "Success: Stopped at intermediate Floor 1";
        
        wait until door_open = '0';
        
        -- Should continue to 0
        wait until DoorOpen = '1';
        assert CurrentFloor = 0 report "Failed: Did not continue to Floor 0" severity error;

        report "Test 3: Soft Reset (GR-5a, VR-3d)";
        -- Request Floor 3
        ReqButtons(3) <= '1';
        wait for CLK_PERIOD * 5;
        ReqButtons(3) <= '0';
        
        -- Assert Soft Reset immediately
        SoftReset <= '1';
        wait for CLK_PERIOD * 5;
        SoftReset <= '0';
        
        -- System should NOT move to 3 because request was cleared.
        wait for 1000 ns;
        assert CurrentFloor = 0 report "Failed: Moved despite Soft Reset" severity error;
        
        report "Test 4: ESTOP (VR-3d)";
        -- Request Floor 3 again
        ReqButtons(3) <= '1';
        wait for CLK_PERIOD * 2;
        ReqButtons(3) <= '0';
        
        wait until moving_up = '1';
        estop <= '1';
        wait for CLK_PERIOD * 5;
        assert MovingUp = '0' report "Failed: Did not halt on ESTOP" severity error;
        
        estop <= '0';
        -- Logic allows recovery from IDLE state usually
        
        report "All tests completed.";
        wait;
    END process;

END Behavioral;
